
<style type="text/css">

  html {
    height: 100%
  }

  body {
    height: 100%;
    margin: 0;
    padding: 0
  }

  #map-canvas {
    width: 100%;
    height: 100%
  }

</style>

<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH-W-G8oHPVT647mSRseuSvRhLUWMQPps&sensor=true">
</script>

<script type="text/javascript">

  var travel =
  {
    origin:       { tracking: false },
    destination:  { tracking: false }
  };

  var map, gc, target;

  function initialize() {
    var mapOptions = {
      center: new google.maps.LatLng(59.96512, 30.15732),
      zoom: 10
    };

    gc  = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

    google.maps.event.addListener(map, 'click', function (click) {

      var markerOptions = {
        position:   click.latLng,
        map:        map,
        draggable:  true
      };

      if (target == null)
      {
        alert("Please, select origin or destination in beforehand!")
        return;
      }

      mark(target, markerOptions)
    });
  }

  function mark(target, options)
  {
    var marker = new google.maps.Marker(options);

    travel[target] = {
      marker: marker,
      input:  {
        address:      $("#travel_" + target + "_attributes_address"),
        coordinates:  $("#travel_" + target + "_attributes_coordinates")
      }
    };

    var setResolved =
        function (address, coordinates) {
          travel[target].input.coordinates.val(coordinates);
          travel[target].input.address.val(address);
        };

    reverseGC(marker.getPosition(), setResolved);

    google.maps.event.addListener(marker, 'dragend', function (_) {
      reverseGC(marker.getPosition(), setResolved);
    });
  }

  function reverseGC(location, callback) {
    gc.geocode({ latLng: location }, function (results, status) {
      if (status == google.maps.GeocoderStatus.OK)
        callback(results[0].formatted_address, location);
      else
        callback(location, location);
    });
  }

  function trackOrigin() {
    target = "origin";
  }

  function trackDestination() {
    target = "destination"
  }

  google.maps.event.addDomListener(window, 'load', initialize);
</script>

<div id="map-canvas" style="top: 0; left: 0; position: absolute;"></div>

<div style="position: absolute; top: 50pt; left: 50pt; height: 150pt; width: 150pt; background: #ffffff; z-index: 10000">

  <div class="content">

    <%= form_for @travel do |form| %>

      <%= render 'origin_field',      form: form %>

      <%= render 'destination_field', form: form %>

      <%= add_link_to_fields(form, :items) %>

      <%= form.submit                       %>

    <% end %>

  </div>

</div>





</div>