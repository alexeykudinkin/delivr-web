<%  ng_model_prefix  = local_assigns[:ngmodel_prefix]

    ng_model_addr    = "#{ng_model_prefix}.address"
    ng_model_coords  = "#{ng_model_prefix}.coordinates"
    ng_model_items   = "#{ng_model_prefix}.items_attributes"

    ng_model_due_date_starts  = "#{ng_model_prefix}.due_date.starts"
    ng_model_due_date_ends    = "#{ng_model_prefix}.due_date.ends"

    ng_form = "destinationSubForm" %>

<div class="<%= local_assigns[:class] %>" ng-click="<%= "registerClickerAndAutoComplete(#{ng_model_prefix}, $event)"%>" ng-form="<%= ng_form %>" verify-address>

  <%= render layout: "layouts/error_labels_layout", locals: { subform: ng_form, props: :address, message: "Missing address" } do %>

    <%= form.text_field :address,     name:         "address",
                                      placeholder:  "Destination",
                                      class:        "address form-control",
                                      ng_model:     ng_model_addr,
                                      ng_required:  true %>

    <%= form.text_field :coordinates, name:         "coordinates",
                                      class:        "coordinates hidden",
                                      ng_model:     ng_model_coords,
                                      ng_required:  true %>

  <% end %>

  <div class="timepicker col-md-6 col-sm-6" ng-controller="TimepickerController">

    <timepicker ng-model      = "<%= ng_model_due_date_starts %>"
                hour-step     = "settings.timepicker.hourStep"
                minute-step   = "settings.timepicker.minuteStep"
                show-meridian = "settings.timepicker.isMeridian"
                mousewheel    = "settings.timepicker.mouseWheel" ></timepicker>

  </div>

  <div class="timepicker col-md-6 col-sm-6" ng-controller="TimepickerController">

    <timepicker ng-model      = "<%= ng_model_due_date_ends %>"
                hour-step     = "settings.timepicker.hourStep"
                minute-step   = "settings.timepicker.minuteStep"
                show-meridian = "settings.timepicker.isMeridian"
                mousewheel    = "settings.timepicker.mouseWheel" ></timepicker>

  </div>

</div>

<%= link_to_add_fields_angular(form, :items, ng_model_prefix) do |gen| %>
  <%= output = <<-RUBY_EVAL
        <div class="" ng-repeat="item in #{ng_model_items}" ng-init="itemsIndex = $index">
          #{ gen.call({ index: "itemsIndex" })}
        </div>
      RUBY_EVAL

      output.html_safe %>
<% end %>

<div class="form-group">
  <%= push_onclick_button_to('Add item', { ng_click: "pushNextItemFor(#{ng_model_prefix})", class: "btn" }) %>
</div>